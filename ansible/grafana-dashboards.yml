
- name: Import Grafana dashboards (using Grafana HTTP API)
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    grafana_namespace: "monitoring"
    grafana_admin_user: "admin"
    grafana_admin_password: "admin"
    grafana_service: ""
  tasks:
    - name: Get Grafana service ClusterIP or LoadBalancer
      command: kubectl get svc -n {{ grafana_namespace }} -l app.kubernetes.io/name=grafana -o jsonpath='{.items[0].spec.clusterIP}'
      register: grafana_ip
      changed_when: false

    - name: Set grafana_service var
      set_fact:
        grafana_service: "{{ grafana_ip.stdout }}"

    - name: Ensure jq is present
      package:
        name: jq
        state: present

    - name: Copy dashboards to temp
      local_action: copy files=../monitoring/dashboards dest=/tmp/grafana-dashboards
      changed_when: false

    - name: Import dashboards via Grafana API (requires network access to cluster)
      uri:
        url: "http://{{ grafana_service }}:3000/api/dashboards/db"
        method: POST
        user: "{{ grafana_admin_user }}"
        password: "{{ grafana_admin_password }}"
        status_code: 200,412,409,201
        body: "{{ lookup('file', item) }}"
        body_format: json
      loop: "{{ lookup('fileglob', '../monitoring/dashboards/*.json', wantlist=True) }}"
      ignore_errors: true
